<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>è§†é¢‘ä¸‹è½½å™¨</title>
  <link rel="icon" href="/static/favicon.svg" type="image/svg+xml" />
  <style>
    /* â”€â”€ Reset & Base â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0f0f13;
      --surface: #1a1a24;
      --surface2: #22222f;
      --border: #2e2e42;
      --accent: #7c6af7;
      --accent2: #a78bfa;
      --green: #22c55e;
      --red: #ef4444;
      --text: #e8e8f0;
      --text2: #9090b0;
      --radius: 16px;
      --shadow: 0 8px 32px rgba(0,0,0,.5);
    }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      font-size: 16px;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: env(safe-area-inset-top, 20px) 16px env(safe-area-inset-bottom, 24px);
      min-height: 100dvh;
    }

    /* â”€â”€ Header â”€â”€ */
    header {
      width: 100%;
      max-width: 540px;
      text-align: center;
      padding: 28px 0 20px;
    }

    header .logo {
      font-size: 2rem;
      margin-bottom: 6px;
    }

    header h1 {
      font-size: 1.4rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent2), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    header p {
      font-size: .85rem;
      color: var(--text2);
      margin-top: 4px;
    }

    .version-badge {
      display: inline-block;
      margin-top: 6px;
      font-size: .7rem;
      color: var(--text2);
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 99px;
      padding: 2px 8px;
      letter-spacing: .04em;
    }

    /* â”€â”€ Card â”€â”€ */
    .card {
      width: 100%;
      max-width: 540px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: var(--shadow);
    }

    /* â”€â”€ URL Input â”€â”€ */
    .input-wrap {
      display: flex;
      gap: 8px;
      align-items: stretch;
    }

    .input-wrap input {
      flex: 1;
      background: var(--surface2);
      border: 1.5px solid var(--border);
      border-radius: 12px;
      padding: 14px 16px;
      color: var(--text);
      font-size: 15px;
      outline: none;
      transition: border-color .2s;
      min-width: 0;
    }

    .input-wrap input::placeholder { color: var(--text2); }
    .input-wrap input:focus { border-color: var(--accent); }

    .btn-paste {
      flex-shrink: 0;
      background: var(--surface2);
      border: 1.5px solid var(--border);
      border-radius: 12px;
      padding: 0 14px;
      color: var(--text2);
      font-size: 13px;
      cursor: pointer;
      transition: all .2s;
      white-space: nowrap;
    }

    .btn-paste:active { background: var(--border); }

    /* â”€â”€ Preview â”€â”€ */
    #preview {
      display: none;
      margin-top: 16px;
      gap: 12px;
      align-items: center;
    }

    #preview.show { display: flex; }

    #preview img {
      width: 96px;
      height: 54px;
      object-fit: cover;
      border-radius: 8px;
      flex-shrink: 0;
      background: var(--surface2);
    }

    .preview-meta { flex: 1; min-width: 0; }

    .preview-meta .ptitle {
      font-size: .9rem;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .preview-meta .pmeta {
      font-size: .78rem;
      color: var(--text2);
      margin-top: 3px;
    }

    /* â”€â”€ Section Label (cookie/history) â”€â”€ */
    .section-label {
      font-size: .8rem;
      color: var(--text2);
      font-weight: 600;
      letter-spacing: .05em;
      text-transform: uppercase;
      margin-bottom: 10px;
    }

    /* â”€â”€ Download Button â”€â”€ */
    #btn-download {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--accent), #9f7aea);
      color: #fff;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: opacity .2s, transform .1s;
      margin-top: 4px;
      letter-spacing: .03em;
    }

    #btn-download:active { transform: scale(.98); }
    #btn-download:disabled { opacity: .4; cursor: default; }

    /* â”€â”€ Progress â”€â”€ */
    #progress-wrap {
      display: none;
      margin-top: 16px;
    }

    #progress-wrap.show { display: block; }

    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    #status-text {
      font-size: .85rem;
      color: var(--text2);
    }

    #pct-text {
      font-size: .85rem;
      font-weight: 700;
      color: var(--accent2);
    }

    .progress-bar-bg {
      height: 8px;
      background: var(--surface2);
      border-radius: 99px;
      overflow: hidden;
    }

    #progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      border-radius: 99px;
      transition: width .4s ease;
    }

    .progress-meta {
      display: flex;
      gap: 16px;
      margin-top: 8px;
      font-size: .78rem;
      color: var(--text2);
    }

    /* â”€â”€ Result â”€â”€ */
    #result-wrap {
      display: none;
      margin-top: 16px;
      text-align: center;
    }

    #result-wrap.show { display: block; }

    .result-icon { font-size: 2.5rem; margin-bottom: 8px; }

    .result-title {
      font-size: .95rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .result-sub {
      font-size: .8rem;
      color: var(--text2);
      margin-bottom: 16px;
    }

    #btn-save {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--green);
      color: #fff;
      border: none;
      border-radius: 14px;
      padding: 14px 28px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: opacity .2s, transform .1s;
      text-decoration: none;
    }

    #btn-save:active { transform: scale(.97); }

    #btn-save-burned {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 14px;
      padding: 14px 28px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: opacity .2s, transform .1s;
      text-decoration: none;
      margin-top: 10px;
    }

    #btn-save-burned:active { transform: scale(.97); }

    .result-downloads {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0;
    }

    #burn-error {
      font-size: .78rem;
      color: #fca5a5;
      background: rgba(239,68,68,.08);
      border: 1px solid rgba(239,68,68,.25);
      border-radius: 10px;
      padding: 8px 12px;
      margin-top: 10px;
      text-align: left;
    }

    .btn-new {
      display: block;
      margin: 12px auto 0;
      background: none;
      border: 1.5px solid var(--border);
      border-radius: 12px;
      padding: 11px 24px;
      color: var(--text2);
      font-size: .9rem;
      cursor: pointer;
      transition: border-color .2s, color .2s;
    }

    .btn-new:hover { border-color: var(--accent); color: var(--accent2); }

    #cookie-status-row { display:flex; align-items:center; gap:8px; font-size:.9rem; color:var(--text2); }
    .btn-cookie-upload {
      display: inline-block;
      padding: 8px 16px;
      background: var(--accent);
      color: #fff;
      border-radius: 10px;
      font-size: .85rem;
      cursor: pointer;
    }
    .btn-cookie-delete {
      padding: 8px 14px;
      background: none;
      border: 1.5px solid var(--border);
      border-radius: 10px;
      color: var(--text2);
      font-size: .85rem;
      cursor: pointer;
    }

    /* Cookie æ± åˆ—è¡¨ */
    .pool-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 7px 0;
      border-bottom: 1px solid var(--border);
      font-size: .82rem;
    }
    .pool-item:last-child { border-bottom: none; }
    .pool-item-name { flex: 1; color: var(--text); min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .pool-item-size { color: var(--text2); flex-shrink: 0; font-size: .75rem; }
    .pool-item-del {
      flex-shrink: 0;
      background: none;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text2);
      font-size: .72rem;
      padding: 2px 8px;
      cursor: pointer;
    }
    .pool-item-del:hover { border-color: var(--red); color: var(--red); }

    /* Cookie çŠ¶æ€å¾½ç«  */
    .cookie-badge {
      display: inline-block;
      font-size: .68rem;
      border-radius: 99px;
      padding: 2px 8px;
      font-weight: 600;
      flex-shrink: 0;
    }
    .cookie-badge-ok      { background: rgba(74,222,128,.15); color: #4ade80; border: 1px solid rgba(74,222,128,.3); }
    .cookie-badge-invalid { background: rgba(239,68,68,.12);  color: #f87171; border: 1px solid rgba(239,68,68,.25); }
    .cookie-badge-unknown { background: var(--surface2);      color: var(--text2); border: 1px solid var(--border); }
    .cookie-badge-checking{ background: rgba(124,106,247,.12);color: var(--accent2); border: 1px solid rgba(124,106,247,.3); animation: pulse-badge 1.2s ease-in-out infinite; }
    @keyframes pulse-badge { 0%,100%{opacity:1} 50%{opacity:.5} }

    .pool-item-meta { font-size: .68rem; color: var(--text2); flex-shrink: 0; }

    /* â”€â”€ Error â”€â”€ */
    #error-wrap {
      display: none;
      margin-top: 12px;
      background: rgba(239,68,68,.1);
      border: 1px solid rgba(239,68,68,.3);
      border-radius: 12px;
      padding: 12px 14px;
      font-size: .85rem;
      color: #fca5a5;
    }

    #error-wrap.show { display: block; }

    /* â”€â”€ Burn Button â”€â”€ */
    #btn-burn {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      margin-top: 14px;
      padding: 12px 26px;
      background: none;
      border: 1.5px solid var(--accent);
      border-radius: 14px;
      color: var(--accent2);
      font-size: .95rem;
      font-weight: 600;
      cursor: pointer;
      transition: background .2s, color .2s;
    }
    #btn-burn:hover { background: rgba(124,106,247,.12); }
    #btn-burn:disabled { opacity: .55; cursor: default; }

    #burn-progress-area {
      margin-top: 10px;
      width: 100%;
      max-width: 320px;
    }
    #burn-status-text {
      font-size: .8rem;
      color: var(--text2);
      margin-bottom: 6px;
    }
    #burn-progress-bar-bg {
      height: 5px;
      background: var(--border);
      border-radius: 99px;
      overflow: hidden;
    }
    #burn-progress-bar {
      height: 100%;
      background: var(--accent);
      border-radius: 99px;
      width: 0%;
      transition: width .4s;
    }

    /* â”€â”€ Tips â”€â”€ */
    .tips {
      max-width: 540px;
      width: 100%;
      padding: 0 4px;
    }

    .tips h3 {
      font-size: .78rem;
      color: var(--text2);
      margin-bottom: 8px;
      font-weight: 600;
      letter-spacing: .05em;
      text-transform: uppercase;
    }

    .tip-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      font-size: .8rem;
      color: var(--text2);
      margin-bottom: 6px;
      line-height: 1.5;
    }

    .tip-icon { flex-shrink: 0; margin-top: 1px; }

    /* â”€â”€ History â”€â”€ */
    .history-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
    }
    .history-item:last-child { border-bottom: none; }
    .history-item:hover .history-title { color: var(--accent2); }

    .history-icon { font-size: 1.2rem; flex-shrink: 0; }

    .history-info { flex: 1; min-width: 0; }

    .history-title {
      font-size: .85rem;
      font-weight: 600;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: color .15s;
    }

    .history-meta {
      font-size: .72rem;
      color: var(--text2);
      margin-top: 2px;
    }

    .history-dl {
      flex-shrink: 0;
      font-size: .75rem;
      color: var(--accent2);
      white-space: nowrap;
      text-decoration: none;
    }

    /* â”€â”€ Spinner â”€â”€ */
    @keyframes spin { to { transform: rotate(360deg); } }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin .7s linear infinite;
      vertical-align: middle;
      margin-right: 6px;
    }
  </style>
</head>
<body>

<header>
  <div class="logo">ğŸ“¥</div>
  <h1>è§†é¢‘ä¸‹è½½å™¨</h1>
  <p>æ”¯æŒ YouTubeã€Bç«™ã€Twitter ç­‰ä¸»æµå¹³å°</p>
  <span class="version-badge">v{{ version }} Â· å­—å¹•çƒ§å½•</span>
</header>

<!-- URL è¾“å…¥å¡ç‰‡ -->
<div class="card" id="card-input">
  <div class="input-wrap">
    <input type="url" id="url-input" placeholder="ç²˜è´´è§†é¢‘é“¾æ¥..." autocomplete="off" autocorrect="off" spellcheck="false" />
    <button class="btn-paste" id="btn-paste">ç²˜è´´</button>
  </div>

  <!-- è§†é¢‘é¢„è§ˆ -->
  <div id="preview">
    <img id="thumb" src="" alt="å°é¢" />
    <div class="preview-meta">
      <div class="ptitle" id="ptitle"></div>
      <div class="pmeta" id="pmeta"></div>
    </div>
  </div>

  <!-- é”™è¯¯æç¤º -->
  <div id="error-wrap"></div>
</div>


<!-- Cookie è½®è¯¢æ± å¡ç‰‡ -->
<div class="card" id="card-cookie">
  <div class="section-label" style="display:flex;align-items:center;justify-content:space-between;">
    <span>YouTube Cookie æ± </span>
    <span id="pool-count-badge" style="font-size:.7rem;background:var(--surface2);border:1px solid var(--border);border-radius:99px;padding:2px 8px;font-weight:400;letter-spacing:0">0 ä¸ª</span>
  </div>
  <div id="pool-list" style="margin-top:8px"></div>
  <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
    <label class="btn-cookie-upload" for="cookie-file-input" style="cursor:pointer;">
      ğŸ“‚ æ·»åŠ  Cookie
      <input type="file" id="cookie-file-input" accept=".txt" style="display:none" />
    </label>
    <button class="btn-cookie-delete" id="btn-check-all" style="font-size:.8rem;padding:7px 14px">ğŸ” æ£€æµ‹å…¨éƒ¨</button>
  </div>
  <div id="cookie-import-msg" style="margin-top:6px;font-size:12px;display:none"></div>
  <div style="margin-top:8px;font-size:12px;color:var(--text2)">
    Cookie å¤±æ•ˆæ—¶è‡ªåŠ¨ç§»é™¤ï¼Œæ— æ³•æ‰‹åŠ¨åˆ é™¤ã€‚å¤šä¸ª Cookie è½®æµä½¿ç”¨é™ä½å°å·é£é™©ã€‚
    <a href="https://github.com/yt-dlp/yt-dlp/wiki/FAQ#how-do-i-pass-cookies-to-yt-dlp" target="_blank" style="color:#7c9ef8">å¦‚ä½•å¯¼å‡º cookies.txt</a>
  </div>
</div>

<!-- ä¸‹è½½æŒ‰é’® + è¿›åº¦ -->
<div class="card">
  <button id="btn-download">å¼€å§‹ä¸‹è½½</button>

  <!-- è¿›åº¦ -->
  <div id="progress-wrap">
    <div class="progress-header">
      <span id="status-text">å‡†å¤‡ä¸­...</span>
      <span id="pct-text">0%</span>
    </div>
    <div class="progress-bar-bg">
      <div id="progress-bar"></div>
    </div>
    <div class="progress-meta">
      <span id="speed-text"></span>
      <span id="eta-text"></span>
    </div>
  </div>

  <!-- å®Œæˆ -->
  <div id="result-wrap">
    <div class="result-icon">âœ…</div>
    <div class="result-title" id="result-title">ä¸‹è½½å®Œæˆï¼</div>
    <div class="result-sub">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ä¿å­˜åˆ°è®¾å¤‡</div>
    <div class="result-downloads">
      <a id="btn-save" href="#" download>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        <span id="btn-save-label">ä¿å­˜åˆ°è®¾å¤‡</span>
      </a>
      <a id="btn-save-burned" href="#" download style="display:none">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        å­—å¹•çƒ§å½•ç‰ˆ
      </a>
      <div id="burn-error" style="display:none"></div>
    </div>
    <!-- çƒ§å½•æŒ‰é’® + è¿›åº¦ï¼ˆä¸‹è½½å®Œæˆåæ˜¾ç¤ºï¼‰ -->
    <div id="burn-action" style="display:none;flex-direction:column;align-items:center">
      <button id="btn-burn">ğŸ€„ çƒ§å½•ä¸­æ–‡å­—å¹•</button>
      <div id="burn-progress-area" style="display:none">
        <div id="burn-status-text">å¤„ç†ä¸­...</div>
        <div id="burn-progress-bar-bg"><div id="burn-progress-bar"></div></div>
      </div>
    </div>
    <button class="btn-new" id="btn-new">ç»§ç»­ä¸‹è½½</button>
  </div>
</div>

<!-- ä¸‹è½½å†å² -->
<div class="card" id="card-history" style="display:none">
  <div class="section-label">æœ€è¿‘ä¸‹è½½</div>
  <div id="history-list"></div>
</div>

<!-- ä½¿ç”¨æç¤º -->
<div class="tips">
  <h3>ä½¿ç”¨è¯´æ˜</h3>
  <div class="tip-item"><span class="tip-icon">ğŸ“±</span><span>ä¸‹è½½å®Œæˆåç‚¹å‡»ã€Œä¿å­˜åˆ°è®¾å¤‡ã€ï¼Œæ–‡ä»¶å°†ä¿å­˜åˆ°æœ¬åœ°</span></div>
  <div class="tip-item"><span class="tip-icon">ğŸ–¼ï¸</span><span>iOSï¼šæ‰“å¼€æ–‡ä»¶ â†’ ç‚¹å‡»åˆ†äº« â†’ å­˜å‚¨åˆ°ç›¸å†Œ</span></div>
  <div class="tip-item"><span class="tip-icon">ğŸµ</span><span>é€‰æ‹© MP3 å¯ä»…ä¸‹è½½éŸ³é¢‘ï¼Œé€‚åˆæ”¶å¬æ­Œæ›²</span></div>
  <div class="tip-item"><span class="tip-icon">ğŸ”—</span><span>æ”¯æŒ YouTubeã€Bç«™ã€Twitter/Xã€Instagram ç­‰</span></div>
</div>

<script>
  // â”€â”€ çŠ¶æ€ â”€â”€
  const selectedQuality = 'best';
  let currentJobId = null;
  let sseSource = null;
  let infoTimer = null;

  // â”€â”€ ä»»åŠ¡çŠ¶æ€æ ‡ç­¾ â”€â”€
  function getStatusLabel(status, queuePos) {
    switch (status) {
      case 'queued':
        return queuePos > 0 ? `æ’é˜Ÿä¸­... å‰æ–¹è¿˜æœ‰ ${queuePos} ä¸ªä»»åŠ¡` : 'å³å°†å¼€å§‹...';
      case 'pending':    return 'å‡†å¤‡ä¸‹è½½...';
      case 'downloading': return 'ä¸‹è½½ä¸­';
      case 'merging':    return 'åˆå¹¶ä¸­...';
      case 'translating': return 'ç¿»è¯‘å­—å¹•ä¸­...';
      case 'burning':    return 'çƒ§å½•å­—å¹•ä¸­...';
      case 'done':       return 'å®Œæˆ';
      case 'error':      return 'ä¸‹è½½å¤±è´¥';
      default:           return 'å¤„ç†ä¸­...';
    }
  }

  // â”€â”€ DOM â”€â”€
  const urlInput      = document.getElementById('url-input');
  const btnPaste      = document.getElementById('btn-paste');
  const btnDownload   = document.getElementById('btn-download');
  const preview       = document.getElementById('preview');
  const thumb         = document.getElementById('thumb');
  const ptitle        = document.getElementById('ptitle');
  const pmeta         = document.getElementById('pmeta');
  const errorWrap     = document.getElementById('error-wrap');
  const progressWrap  = document.getElementById('progress-wrap');
  const resultWrap    = document.getElementById('result-wrap');
  const progressBar   = document.getElementById('progress-bar');
  const pctText       = document.getElementById('pct-text');
  const statusText    = document.getElementById('status-text');
  const speedText     = document.getElementById('speed-text');
  const etaText       = document.getElementById('eta-text');
  const resultTitle   = document.getElementById('result-title');
  const btnSave       = document.getElementById('btn-save');
  const btnSaveLabel  = document.getElementById('btn-save-label');
  const btnSaveBurned    = document.getElementById('btn-save-burned');
  const burnErrorEl      = document.getElementById('burn-error');
  const btnNew           = document.getElementById('btn-new');
  const btnBurn          = document.getElementById('btn-burn');
  const burnAction       = document.getElementById('burn-action');
  const burnProgressArea = document.getElementById('burn-progress-area');
  const burnStatusText   = document.getElementById('burn-status-text');
  const burnProgressBar  = document.getElementById('burn-progress-bar');

  let burnPollTimer = null;

  // â”€â”€ ç²˜è´´ â”€â”€
  btnPaste.addEventListener('click', async () => {
    try {
      const text = await navigator.clipboard.readText();
      urlInput.value = text.trim();
      urlInput.dispatchEvent(new Event('input'));
    } catch {
      urlInput.focus();
    }
  });

  // â”€â”€ URL å˜åŒ– â†’ è·å–è§†é¢‘ä¿¡æ¯ â”€â”€
  urlInput.addEventListener('input', () => {
    clearTimeout(infoTimer);
    hideError();
    const url = urlInput.value.trim();
    if (!url || !url.startsWith('http')) {
      preview.classList.remove('show');
      return;
    }
    infoTimer = setTimeout(() => fetchInfo(url), 800);
  });

  async function fetchInfo(url) {
    try {
      const res = await fetch('/api/info', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url }),
      });
      const data = await res.json();
      if (data.error) { preview.classList.remove('show'); return; }

      thumb.src = data.thumbnail || '';
      ptitle.textContent = data.title || '';
      pmeta.textContent = [data.uploader, data.duration].filter(Boolean).join('  Â·  ');
      preview.classList.add('show');
    } catch {
      preview.classList.remove('show');
    }
  }

  // â”€â”€ å¼€å§‹ä¸‹è½½ â”€â”€
  btnDownload.addEventListener('click', startDownload);

  async function startDownload() {
    const url = urlInput.value.trim();
    if (!url) { showError('è¯·å…ˆè¾“å…¥è§†é¢‘é“¾æ¥'); return; }

    hideError();
    setDownloading(true);
    progressWrap.classList.add('show');
    resultWrap.classList.remove('show');
    setProgress(0, 'è¿æ¥ä¸­...');

    try {
      const res = await fetch('/api/download', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          url,
          quality: selectedQuality,
        }),
      });
      const data = await res.json();
      if (data.error) { showError(data.error); setDownloading(false); return; }

      currentJobId = data.job_id;
      localStorage.setItem('activeJobId', data.job_id);
      listenProgress(currentJobId);
    } catch (e) {
      showError('ç½‘ç»œé”™è¯¯ï¼š' + e.message);
      setDownloading(false);
    }
  }

  function listenProgress(jobId) {
    if (sseSource) sseSource.close();

    sseSource = new EventSource(`/api/progress/${jobId}`);
    let finished = false;
    let errCount = 0;

    sseSource.onmessage = (e) => {
      errCount = 0; // æ”¶åˆ°æ¶ˆæ¯å³é‡ç½®é”™è¯¯è®¡æ•°
      const job = JSON.parse(e.data);

      if (job.status === 'queued' || job.status === 'pending') {
        // æ’é˜Ÿç­‰å¾…ä¸­
        const pos = job.queue_pos || 0;
        const msg = pos > 0 ? `æ’é˜Ÿä¸­... å‰æ–¹è¿˜æœ‰ ${pos} ä¸ªä»»åŠ¡` : 'å³å°†å¼€å§‹...';
        setProgress(0, msg);
        speedText.textContent = '';
        etaText.textContent   = '';
      } else if (job.status === 'downloading') {
        setProgress(job.progress, 'ä¸‹è½½ä¸­');
        speedText.textContent = job.speed ? `é€Ÿåº¦ï¼š${job.speed}` : '';
        etaText.textContent   = job.eta   ? `å‰©ä½™ï¼š${job.eta}`  : '';
      } else if (job.status === 'merging') {
        setProgress(99, 'åˆå¹¶ä¸­...');
        speedText.textContent = '';
        etaText.textContent   = '';
      } else if (job.status === 'translating') {
        setProgress(99, 'ç¿»è¯‘å­—å¹•ä¸­...');
        speedText.textContent = '';
        etaText.textContent   = '';
      } else if (job.status === 'burning') {
        setProgress(job.progress, 'çƒ§å½•å­—å¹•ä¸­...');
        speedText.textContent = '';
        etaText.textContent   = '';
      } else if (job.status === 'done') {
        finished = true;
        sseSource.close();
        localStorage.removeItem('activeJobId');
        setProgress(100, 'å®Œæˆ');
        setTimeout(() => showResult(jobId, job), 400);
      } else if (job.status === 'error') {
        finished = true;
        sseSource.close();
        localStorage.removeItem('activeJobId');
        showError(job.error || 'ä¸‹è½½å¤±è´¥');
        setDownloading(false);
        progressWrap.classList.remove('show');
      }
    };

    // SSE æ–­çº¿æ—¶æµè§ˆå™¨ä¼šè‡ªåŠ¨é‡è¿ï¼›åªåœ¨æŒç»­å¤±è´¥ï¼ˆçº¦2.5åˆ†é’Ÿï¼‰åæ‰æç¤ºç”¨æˆ·
    sseSource.onerror = () => {
      if (finished) { sseSource.close(); return; }
      errCount++;
      if (errCount >= 30) {
        sseSource.close();
        showError('è¿æ¥æŒç»­æ–­å¼€ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ä»»åŠ¡è¿›åº¦');
        setDownloading(false);
        progressWrap.classList.remove('show');
      }
    };
  }

  // â”€â”€ é¡µé¢åˆ·æ–°åæ¢å¤è¿›è¡Œä¸­çš„ä»»åŠ¡ â”€â”€
  async function recoverActiveJob() {
    // ä¼˜å…ˆä»æœåŠ¡å™¨æŸ¥è¯¢å½“å‰ç”¨æˆ·çš„æ´»è·ƒä»»åŠ¡
    try {
      const res = await fetch('/api/jobs/active');
      if (res.ok) {
        const activeJobs = await res.json();
        if (activeJobs.length > 0) {
          const job = activeJobs[0]; // å–æœ€æ–°çš„ä¸€ä¸ª
          currentJobId = job.job_id;
          localStorage.setItem('activeJobId', job.job_id);
          progressWrap.classList.add('show');
          setProgress(job.progress || 0, getStatusLabel(job.status, job.queue_pos));
          setDownloading(true);
          listenProgress(job.job_id);
          return;
        }
      }
    } catch (_) {}

    // å›é€€ï¼šä» localStorage è¯»å–ä¿å­˜çš„ jobId
    const savedJobId = localStorage.getItem('activeJobId');
    if (!savedJobId) return;

    try {
      const res = await fetch(`/api/job/${savedJobId}`);
      if (!res.ok) { localStorage.removeItem('activeJobId'); return; }
      const job = await res.json();
      if (job.error) { localStorage.removeItem('activeJobId'); return; }

      if (job.status === 'done') {
        localStorage.removeItem('activeJobId');
        showResult(savedJobId, job);
      } else if (job.status === 'error') {
        localStorage.removeItem('activeJobId');
      } else {
        // ä»åœ¨è¿›è¡Œä¸­ï¼Œé‡æ–°è¿æ¥ SSE
        currentJobId = savedJobId;
        progressWrap.classList.add('show');
        setProgress(job.progress || 0, getStatusLabel(job.status, job.queue_pos));
        setDownloading(true);
        listenProgress(savedJobId);
      }
    } catch (_) {
      localStorage.removeItem('activeJobId');
    }
  }

  function showResult(jobId, job) {
    setDownloading(false);
    progressWrap.classList.remove('show');
    resultWrap.classList.add('show');
    resultTitle.textContent = job.title ? `ã€Š${job.title}ã€‹` : 'ä¸‹è½½å®Œæˆï¼';

    const origFilename = job.original_filename || job.filename || 'video.mp4';
    btnSave.href = `/api/file/${jobId}/original`;
    btnSave.download = origFilename;

    const burnSt = job.burn_status || 'idle';

    if (job.burned_filename) {
      // å·²çƒ§å½•å®Œæˆ
      btnSaveLabel.textContent = 'åŸå§‹è§†é¢‘';
      btnSaveBurned.href = `/api/file/${jobId}/burned`;
      btnSaveBurned.download = job.burned_filename;
      btnSaveBurned.style.display = 'inline-flex';
      burnAction.style.display = 'none';
    } else {
      btnSaveLabel.textContent = 'ä¿å­˜åˆ°è®¾å¤‡';
      btnSaveBurned.style.display = 'none';
      // æ˜¾ç¤ºçƒ§å½•æŒ‰é’®åŒº
      burnAction.style.display = 'flex';
      if (burnSt === 'idle' || burnSt === 'error') {
        btnBurn.disabled = false;
        btnBurn.textContent = 'ğŸ€„ çƒ§å½•ä¸­æ–‡å­—å¹•';
        burnProgressArea.style.display = 'none';
      } else {
        // æ­£åœ¨çƒ§å½•ï¼ˆpending/translating/burningï¼‰
        btnBurn.disabled = true;
        burnProgressArea.style.display = 'block';
        updateBurnProgressUI(burnSt, job.burn_progress || 0);
        if (!burnPollTimer) startBurnPoll(jobId);
      }
    }

    if (job.burn_error) {
      burnErrorEl.textContent = 'âš ï¸ ' + job.burn_error;
      burnErrorEl.style.display = 'block';
    } else {
      burnErrorEl.style.display = 'none';
    }
  }

  function updateBurnProgressUI(status, pct) {
    if (status === 'translating' || status === 'pending') {
      burnStatusText.textContent = 'ç¿»è¯‘å­—å¹•ä¸­...';
      burnProgressBar.style.width = '30%';
    } else if (status === 'burning') {
      burnStatusText.textContent = `çƒ§å½•ä¸­ ${pct}%`;
      burnProgressBar.style.width = pct + '%';
    }
  }

  // â”€â”€ çƒ§å½•æŒ‰é’®ç‚¹å‡» â”€â”€
  btnBurn.addEventListener('click', async () => {
    if (!currentJobId) return;
    btnBurn.disabled = true;
    burnProgressArea.style.display = 'block';
    burnStatusText.textContent = 'å‡†å¤‡ä¸­...';
    burnProgressBar.style.width = '0%';
    burnErrorEl.style.display = 'none';

    try {
      const res = await fetch(`/api/burn/${currentJobId}`, { method: 'POST' });
      const data = await res.json();
      if (data.error) {
        burnErrorEl.textContent = 'âš ï¸ ' + data.error;
        burnErrorEl.style.display = 'block';
        btnBurn.disabled = false;
        burnProgressArea.style.display = 'none';
        return;
      }
      startBurnPoll(currentJobId);
    } catch (e) {
      burnErrorEl.textContent = 'âš ï¸ ç½‘ç»œé”™è¯¯ï¼š' + e.message;
      burnErrorEl.style.display = 'block';
      btnBurn.disabled = false;
      burnProgressArea.style.display = 'none';
    }
  });

  function startBurnPoll(jobId) {
    if (burnPollTimer) clearInterval(burnPollTimer);
    burnPollTimer = setInterval(async () => {
      try {
        const res = await fetch(`/api/job/${jobId}`);
        if (!res.ok) return;
        const job = await res.json();
        const st = job.burn_status || 'idle';

        if (st === 'done') {
          clearInterval(burnPollTimer); burnPollTimer = null;
          // åˆ·æ–°ç»“æœåŒºæ˜¾ç¤ºçƒ§å½•ç‰ˆä¸‹è½½
          showResult(jobId, job);
          loadHistory();
        } else if (st === 'error') {
          clearInterval(burnPollTimer); burnPollTimer = null;
          burnProgressArea.style.display = 'none';
          btnBurn.disabled = false;
          btnBurn.textContent = 'ğŸ€„ é‡æ–°çƒ§å½•';
          burnErrorEl.textContent = 'âš ï¸ ' + (job.burn_error || 'çƒ§å½•å¤±è´¥');
          burnErrorEl.style.display = 'block';
        } else {
          updateBurnProgressUI(st, job.burn_progress || 0);
        }
      } catch (_) {}
    }, 1000);
  }

  // â”€â”€ ç»§ç»­ä¸‹è½½ â”€â”€
  btnNew.addEventListener('click', () => {
    if (sseSource) { sseSource.close(); sseSource = null; }
    if (burnPollTimer) { clearInterval(burnPollTimer); burnPollTimer = null; }
    localStorage.removeItem('activeJobId');
    urlInput.value = '';
    preview.classList.remove('show');
    resultWrap.classList.remove('show');
    progressWrap.classList.remove('show');
    hideError();
    setProgress(0, 'å‡†å¤‡ä¸­...');
    currentJobId = null;
    btnSaveBurned.style.display = 'none';
    burnErrorEl.style.display = 'none';
    burnAction.style.display = 'none';
    burnProgressArea.style.display = 'none';
    btnSaveLabel.textContent = 'ä¿å­˜åˆ°è®¾å¤‡';
    urlInput.focus();
  });

  // â”€â”€ è¾…åŠ© â”€â”€
  function setProgress(pct, label) {
    progressBar.style.width = pct + '%';
    pctText.textContent = Math.round(pct) + '%';
    statusText.textContent = label;
  }

  function setDownloading(on) {
    btnDownload.disabled = on;
    btnDownload.innerHTML = on
      ? '<span class="spinner"></span>ä¸‹è½½ä¸­...'
      : 'å¼€å§‹ä¸‹è½½';
  }

  function showError(msg) {
    errorWrap.textContent = 'âš ï¸ ' + msg;
    errorWrap.classList.add('show');
  }

  function hideError() {
    errorWrap.classList.remove('show');
  }

  // iOS Safariï¼šé•¿æŒ‰ä¿å­˜æç¤º
  function iosDownloadAlert() {
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    if (isIOS) {
      setTimeout(() => {
        alert('æç¤ºï¼šæ–‡ä»¶å·²ä¸‹è½½åˆ°"æ–‡ä»¶"Appï¼Œå¯ä»æ–‡ä»¶ App ä¿å­˜åˆ°ç›¸å†Œã€‚');
      }, 1000);
    }
  }
  btnSave.addEventListener('click', iosDownloadAlert);
  btnSaveBurned.addEventListener('click', iosDownloadAlert);

  // â”€â”€ Cookie è½®è¯¢æ± ç®¡ç† â”€â”€
  const cookieFileInput = document.getElementById('cookie-file-input');
  const cookieImportMsg = document.getElementById('cookie-import-msg');
  const poolList        = document.getElementById('pool-list');
  const poolBadge       = document.getElementById('pool-count-badge');
  const btnCheckAll     = document.getElementById('btn-check-all');

  function showImportMsg(text, isError) {
    cookieImportMsg.textContent = text;
    cookieImportMsg.style.color = isError ? '#f87171' : '#4ade80';
    cookieImportMsg.style.display = 'block';
    setTimeout(() => { cookieImportMsg.style.display = 'none'; }, 5000);
  }

  function cookieBadge(c) {
    if (c.checking) return '<span class="cookie-badge cookie-badge-checking">â³ æ£€æµ‹ä¸­</span>';
    if (c.valid === true)  return '<span class="cookie-badge cookie-badge-ok">âœ… æ­£å¸¸</span>';
    if (c.valid === false) return '<span class="cookie-badge cookie-badge-invalid">âŒ å·²å¤±æ•ˆ</span>';
    return '<span class="cookie-badge cookie-badge-unknown">âšª æœªéªŒè¯</span>';
  }

  function cookieMeta(c) {
    const parts = [];
    if (c.use_count > 0) parts.push(`${c.use_count}æ¬¡`);
    if (c.last_used_ago) parts.push(c.last_used_ago);
    return parts.length ? `<span class="pool-item-meta">${parts.join(' Â· ')}</span>` : '';
  }

  let _checkPollTimer = null;

  function loadCookiePool() {
    fetch('/api/cookies/pool').then(r => r.json()).then(pool => {
      const okCount = pool.filter(c => c.valid !== false).length;
      poolBadge.textContent = pool.length + ' ä¸ª';
      poolBadge.style.color = pool.length ? 'var(--green)' : 'var(--text2)';
      if (!pool.length) {
        poolList.innerHTML = '<div style="font-size:.8rem;color:var(--text2);padding:6px 0">æš‚æ—  Cookieï¼Œä¸‹è½½æ—¶å¯èƒ½é‡åˆ°åçˆ¬é™åˆ¶</div>';
        return;
      }
      poolList.innerHTML = pool.map((c, i) => `
        <div class="pool-item">
          <span class="pool-item-name">Cookie ${i + 1}</span>
          <span class="pool-item-size" style="color:var(--text2);font-size:.72rem">${c.size_kb} KB</span>
          ${cookieBadge(c)}
          ${cookieMeta(c)}
        </div>
      `).join('');

      // è‹¥æœ‰ checking çŠ¶æ€ï¼Œç»§ç»­è½®è¯¢
      const anyChecking = pool.some(c => c.checking);
      if (anyChecking && !_checkPollTimer) {
        _checkPollTimer = setInterval(() => {
          fetch('/api/cookies/pool').then(r => r.json()).then(p2 => {
            if (!p2.some(c => c.checking)) {
              clearInterval(_checkPollTimer); _checkPollTimer = null;
              btnCheckAll.disabled = false;
              btnCheckAll.textContent = 'ğŸ” æ£€æµ‹å…¨éƒ¨';
            }
            // åˆ·æ–°æ•´ä¸ªåˆ—è¡¨
            loadCookiePool();
          }).catch(() => {});
        }, 1500);
      } else if (!anyChecking && _checkPollTimer) {
        clearInterval(_checkPollTimer); _checkPollTimer = null;
        btnCheckAll.disabled = false;
        btnCheckAll.textContent = 'ğŸ” æ£€æµ‹å…¨éƒ¨';
      }
    }).catch(() => {});
  }

  btnCheckAll.addEventListener('click', () => {
    btnCheckAll.disabled = true;
    btnCheckAll.textContent = 'æ£€æµ‹ä¸­...';
    fetch('/api/cookies/check_all', { method: 'POST' })
      .then(r => r.json())
      .then(d => {
        if (d.checking === 0) {
          btnCheckAll.disabled = false;
          btnCheckAll.textContent = 'ğŸ” æ£€æµ‹å…¨éƒ¨';
          showImportMsg('æš‚æ—  Cookie å¯æ£€æµ‹', false);
          return;
        }
        loadCookiePool(); // è§¦å‘è½®è¯¢
      })
      .catch(() => { btnCheckAll.disabled = false; btnCheckAll.textContent = 'ğŸ” æ£€æµ‹å…¨éƒ¨'; });
  });

  cookieFileInput.addEventListener('change', () => {
    const file = cookieFileInput.files[0];
    if (!file) return;
    const fd = new FormData();
    fd.append('file', file);
    fetch('/api/cookies/upload', { method: 'POST', body: fd })
      .then(r => r.json())
      .then(d => {
        cookieFileInput.value = '';
        if (d.ok) {
          showImportMsg(`âœ… Cookie å·²åŠ å…¥æ± ï¼ˆå…± ${d.count} ä¸ªï¼‰`, false);
          loadCookiePool();
        } else {
          showImportMsg('âŒ ä¸Šä¼ å¤±è´¥ï¼š' + (d.error || 'æœªçŸ¥é”™è¯¯'), true);
        }
      })
      .catch(() => showImportMsg('âŒ ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•', true));
  });

  // ä¸‹è½½å‡ºç° bot æ£€æµ‹é”™è¯¯æ—¶æç¤ºé‡æ–°ä¸Šä¼ 
  const _origShowError = showError;
  showError = function(msg) {
    _origShowError(msg);
    if (msg && (msg.includes('Sign in') || msg.includes('bot') || msg.includes('æœºå™¨äºº'))) {
      showImportMsg('âš ï¸ Cookie å¯èƒ½å·²å¤±æ•ˆï¼Œè¯·æ·»åŠ æ–°çš„ cookies.txt', true);
    }
  };

  loadCookiePool();

  // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ¢å¤è¿›è¡Œä¸­çš„ä»»åŠ¡ï¼ˆåˆ·æ–°é¡µé¢ä¸æ–­ä»»åŠ¡ï¼‰
  recoverActiveJob();

  // â”€â”€ ä¸‹è½½å†å² â”€â”€
  const cardHistory = document.getElementById('card-history');
  const historyList = document.getElementById('history-list');

  function formatTime(ts) {
    if (!ts) return '';
    const d = new Date(ts * 1000);
    const now = new Date();
    if (d.toDateString() === now.toDateString()) {
      return d.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    }
    return d.toLocaleDateString('zh-CN', { month: 'numeric', day: 'numeric' }) + ' ' +
           d.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
  }

  function loadHistory() {
    fetch('/api/history')
      .then(r => r.json())
      .then(list => {
        const done = list.filter(x => x.status === 'done');
        if (!done.length) { cardHistory.style.display = 'none'; return; }
        cardHistory.style.display = '';
        historyList.innerHTML = done.map(item => {
          const burnSt = item.burn_status || 'idle';
          let burnBtn = '';
          if (item.burned_filename) {
            burnBtn = `<a class="history-dl" href="/api/file/${item.job_id}/burned" download="${item.burned_filename}" style="margin-left:6px">â†“ çƒ§å½•ç‰ˆ</a>`;
          } else if (burnSt === 'translating' || burnSt === 'burning' || burnSt === 'pending') {
            burnBtn = `<span class="history-dl" style="margin-left:6px;opacity:.5;cursor:default">çƒ§å½•ä¸­...</span>`;
          } else {
            burnBtn = `<button class="history-dl history-burn-btn" data-jobid="${item.job_id}" style="margin-left:6px;background:none;border:1px solid var(--accent);color:var(--accent2);border-radius:8px;padding:4px 10px;cursor:pointer;font-size:.75rem">ğŸ€„ çƒ§å½•</button>`;
          }
          const dlLinks = `<a class="history-dl" href="/api/file/${item.job_id}/original" download="${item.filename || 'video'}">â†“ ä¿å­˜</a>${burnBtn}`;
          return `
          <div class="history-item" data-url="${item.url}" data-jobid="${item.job_id}">
            <span class="history-icon">ğŸ¬</span>
            <div class="history-info">
              <div class="history-title">${item.title || item.filename || 'æœªçŸ¥'}</div>
              <div class="history-meta">${formatTime(item.completed_at)}</div>
            </div>
            <div style="flex-shrink:0">${dlLinks}</div>
          </div>`;
        }).join('');

        historyList.querySelectorAll('.history-item').forEach(el => {
          el.addEventListener('click', e => {
            if (e.target.closest('.history-dl')) return;
            const url = el.dataset.url;
            if (url) {
              urlInput.value = url;
              urlInput.dispatchEvent(new Event('input'));
              window.scrollTo({ top: 0, behavior: 'smooth' });
            }
          });
        });

        // å†å²çƒ§å½•æŒ‰é’®
        historyList.querySelectorAll('.history-burn-btn').forEach(btn => {
          btn.addEventListener('click', async e => {
            e.stopPropagation();
            const jid = btn.dataset.jobid;
            btn.textContent = 'çƒ§å½•ä¸­...';
            btn.disabled = true;
            try {
              const res = await fetch(`/api/burn/${jid}`, { method: 'POST' });
              const data = await res.json();
              if (data.error) { btn.textContent = 'å¤±è´¥'; return; }
              // è½®è¯¢ç­‰å¾…å®Œæˆååˆ·æ–°å†å²
              const t = setInterval(async () => {
                try {
                  const r2 = await fetch(`/api/job/${jid}`);
                  if (!r2.ok) return;
                  const j2 = await r2.json();
                  if (j2.burn_status === 'done' || j2.burn_status === 'error') {
                    clearInterval(t);
                    loadHistory();
                  }
                } catch (_) {}
              }, 1500);
            } catch (_) { btn.textContent = 'å¤±è´¥'; }
          });
        });
      })
      .catch(() => {});
  }

  // åˆå§‹åŠ è½½å†å²ï¼Œä¸‹è½½å®Œæˆååˆ·æ–°
  loadHistory();

  const _origShowResult = showResult;
  showResult = function(jobId, job) {
    _origShowResult(jobId, job);
    setTimeout(loadHistory, 500);
  };
</script>
</body>
</html>
